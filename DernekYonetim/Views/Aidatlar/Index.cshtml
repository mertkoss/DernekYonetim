@model List<DernekYonetim.Models.UyeListesiViewModel>

@{
    ViewData["Title"] = "Üye Listesi ve Aidat Takibi";
    Layout = "_Layout";
}

<style>
    /* Tablo Tasarımı */
    .table-container {
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }

    .main-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .main-row:hover {
            background-color: #f8f9fa;
        }

    /* Detay Satırı */
    .detail-row {
        display: none;
        background-color: #fcfcfc;
    }

    /* Aidat Etiketi */
    .badge-aidat {
        background-color: #e9ecef;
        color: #495057;
        border: 1px solid #ced4da;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-right: 3px;
        margin-bottom: 3px;
        display: inline-block;
    }

    .badge-yok {
        background-color: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .toggle-icon {
        transition: transform 0.3s;
    }

    .open .toggle-icon {
        transform: rotate(90deg);
    }

    /* Modal İçi Düzenlemeler */
    .nav-tabs .nav-link.active {
        font-weight: bold;
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
    }
</style>

<section class="page-section" style="padding-top:100px;">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="section-heading text-uppercase">Üye Yönetimi</h2>
                <p class="text-muted">Üye listesi, detay bilgileri ve aidat geçmişi.</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#yeniUyeModal" onclick="resetForm()">
                    <i class="fa fa-plus"></i> Yeni Üye Ekle
                </button>
            </div>
        </div>

        <div class="table-container table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-dark text-center">
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Üye No</th>
                        <th>Ad Soyad</th>
                        <th>Telefon</th>
                        <th>Meslek</th>
                        <th>Ödenen Aidatlar</th>
                        <th style="width: 100px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="main-row" onclick="toggleRow(@item.UyeId)">
                            <td class="text-center"><i id="icon-@item.UyeId" class="fa fa-chevron-right toggle-icon text-muted"></i></td>
                            <td class="fw-bold text-center">@item.UyeNo</td>
                            <td>
                                <div class="fw-bold">
                                    @item.AdSoyad
                                </div>
                                @if (item.Vefat)
                                {
                                    <small class="text-danger fw-bold">(VEFAT)</small>
                                }
                            </td>
                            <td>@item.Telefon</td>
                            <td>@item.Meslek</td>

                            <td>
                                @if (item.OdenenAidatlar != null && item.OdenenAidatlar.Any())
                                {
                                    @foreach (var aidat in item.OdenenAidatlar)
                                    {
                                        <span class="badge-aidat">
                                            @aidat.Yil: @aidat.Tutar?.ToString("N0") TL
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="badge-yok">Ödeme Yok</span>
                                }
                            </td>

                            <td class="text-center" onclick="event.stopPropagation()">
                                <button class="btn btn-sm btn-outline-warning" title="Düzenle" onclick="editUye(@item.UyeId)">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" title="Sil"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>

                        <tr id="detail-@item.UyeId" class="detail-row">
                            <td colspan="7">
                                <div class="p-3">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h6 class="text-primary fw-bold">Kimlik Bilgileri</h6>
                                            <ul class="list-unstyled text-muted small">
                                                <li><strong>TC No:</strong> @item.TcKimlikNo</li>
                                                <li><strong>Doğum:</strong> @(item.DogumTarihi != null ? item.DogumTarihi.Value.ToString("dd.MM.yyyy") : "-") / @item.DogumYeri</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-primary fw-bold">Eğitim</h6>
                                            <ul class="list-unstyled text-muted small">
                                                <li>@item.Universite</li>
                                                <li>Mezuniyet: @item.MezuniyetYili</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-primary fw-bold">İletişim</h6>
                                            <ul class="list-unstyled text-muted small">
                                                <li>@item.Email</li>
                                                <li>@item.AdresTam</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-primary fw-bold">Diğer</h6>
                                            <ul class="list-unstyled text-muted small">
                                                <li><strong>Üyelik Tarihi:</strong> @item.UyelikTarihi.ToShortDateString()</li>
                                                <li>
                                                    <strong>Derbis:</strong>
                                                    @if (item.DerbisDurumu == "Evet")
                                                    {
                                                        <span class="badge bg-success"><i class="fa fa-check-circle"></i> Kaydı Var</span>
                                                    }
                                                    else if (item.DerbisDurumu == "Hayır")
                                                    {
                                                        <span class="badge bg-danger"><i class="fa fa-times-circle"></i> Kaydı Yok</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Belirtilmedi</span>
                                                    }
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>

<div class="modal fade" id="yeniUyeModal" tabindex="-1" aria-labelledby="yeniUyeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="yeniUyeModalLabel"><i class="fa fa-user-plus"></i> Yeni Üye Kaydı</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>

            <form id="uyeForm" action="/Aidatlar/YeniUyeEkle" method="post">
                @Html.AntiForgeryToken()

                <input type="hidden" name="UyeId" id="hiddenUyeId" value="0" />

                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="uyeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="kimlik-tab" data-bs-toggle="tab" data-bs-target="#kimlik" type="button" role="tab">Kimlik Bilgileri</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="iletisim-tab" data-bs-toggle="tab" data-bs-target="#iletisim" type="button" role="tab">İletişim</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="egitim-tab" data-bs-toggle="tab" data-bs-target="#egitim" type="button" role="tab">Eğitim & Meslek</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diger-tab" data-bs-toggle="tab" data-bs-target="#diger" type="button" role="tab">Derbis & İlk Aidat</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="uyeTabsContent">

                        <div class="tab-pane fade show active" id="kimlik" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Üye No</label>
                                    <input type="text" name="UyeNo" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Üyelik Tarihi</label>
                                    <input type="date" name="UyelikTarihi" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">TC Kimlik No</label>
                                    <input type="text" name="TckimlikNo" class="form-control" required maxlength="11">
                                </div>
                                <div class="col-md-6">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Ad</label>
                                    <input type="text" name="Ad" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Soyad</label>
                                    <input type="text" name="Soyad" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Evlilik Soyadı</label>
                                    <input type="text" name="EvlilikSoyadi" class="form-control" placeholder="(Varsa)">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Doğum Tarihi</label>
                                    <input type="date" name="DogumTarihi" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Doğum Yeri</label>
                                    <input type="text" name="DogumYeri" class="form-control">
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="Vefat" value="true" id="vefatCheck">
                                        <label class="form-check-label text-danger fw-bold" for="vefatCheck">
                                            Vefat Durumu
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="iletisim" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Telefon</label>
                                    <input type="text" name="Telefon" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">E-Mail</label>
                                    <input type="email" name="Email" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">İl</label>
                                    <input type="text" name="Il" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">İlçe</label>
                                    <input type="text" name="Ilce" class="form-control">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Tam Adres</label>
                                    <textarea name="Adres" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="egitim" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Üniversite</label>
                                    <input type="text" name="Universite" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fakülte</label>
                                    <input type="text" name="Fakulte" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Mezuniyet Yılı</label>
                                    <input type="number" name="MezuniyetYili" class="form-control" placeholder="YYYY">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Meslek</label>
                                    <input type="text" name="Meslek" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="diger" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-12">
                                    <h6 class="text-secondary border-bottom pb-2">Derbis Kaydı</h6>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Derbis Durumu</label>
                                    <select name="KayitDurumu" class="form-select">
                                        <option value="Belirtilmedi" selected>Belirtilmedi</option>
                                        <option value="Var">Derbis Kaydı Var</option>
                                        <option value="Yok">Derbis Kaydı Yok</option>
                                    </select>
                                </div>

                                <div class="col-12 mt-4">
                                    <h6 class="text-secondary border-bottom pb-2">Aidat İşlemleri</h6>
                                </div>

                                <div class="col-12 mb-2">
                                    <label class="form-label text-muted small">Ödenmiş Aidatlar:</label>
                                    <div id="aidatListesiBadge" class="d-flex flex-wrap gap-2">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Yeni Aidat Yılı</label>
                                    <input type="number" name="AidatYili" class="form-control" value="@DateTime.Now.Year">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Yeni Aidat Tutarı (TL)</label>
                                    <input type="number" step="0.01" name="AidatTutari" class="form-control" placeholder="Tutar Giriniz">
                                </div>
                                <div class="col-12">
                                    <small class="text-muted fst-italic">* Tutar girip kaydederseniz yeni ödeme eklenir.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" id="btnKaydet" class="btn btn-primary"><i class="fa fa-save"></i> Üyeyi Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Tablo açılır/kapanır satır kodu
    function toggleRow(id) {
        var detailRow = document.getElementById('detail-' + id);
        var icon = document.getElementById('icon-' + id);
        var mainRow = detailRow.previousElementSibling;

        if (detailRow.style.display === "table-row") {
            detailRow.style.display = "none";
            mainRow.classList.remove("open");
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-right");
        } else {
            detailRow.style.display = "table-row";
            mainRow.classList.add("open");
            icon.classList.remove("fa-chevron-right");
            icon.classList.add("fa-chevron-down");
        }
    }

    // --- YENİ EKLENEN KISIM: DÜZENLEME FONKSİYONLARI ---

    // 1. Yeni Üye Butonuna Basınca Formu Temizle
    function resetForm() {
        document.getElementById("uyeForm").reset(); // Formu sıfırla
        document.getElementById("uyeForm").action = "/Aidatlar/YeniUyeEkle"; // Rotayı "Ekle" yap
        document.getElementById("hiddenUyeId").value = "0"; // ID'yi sıfırla
        document.getElementById("yeniUyeModalLabel").innerHTML = '<i class="fa fa-user-plus"></i> Yeni Üye Kaydı';
        document.getElementById("btnKaydet").innerHTML = '<i class="fa fa-save"></i> Üyeyi Kaydet';

        // Aidat kısmını aktif et (Yeni üyede aidat girilebilir)
        document.querySelector('input[name="AidatYili"]').disabled = false;
        document.querySelector('input[name="AidatTutari"]').disabled = false;
    }

    // 2. Düzenle Butonuna Basınca Verileri Çek ve Modalı Aç
    function editUye(id) {
         fetch('/Aidatlar/UyeGetir/' + id)
             .then(response => response.json())
             .then(data => {
                 document.getElementById("uyeForm").action = "/Aidatlar/UyeGuncelle";
                 document.getElementById("hiddenUyeId").value = data.uyeId;

                 document.getElementById("yeniUyeModalLabel").innerHTML = '<i class="fa fa-edit"></i> Üye Düzenle: ' + data.ad + ' ' + data.soyad;
                 document.getElementById("btnKaydet").innerHTML = '<i class="fa fa-refresh"></i> Güncelle';

                 // Inputları Doldur
                 document.querySelector('input[name="UyeNo"]').value = data.uyeNo;
                 document.querySelector('input[name="UyelikTarihi"]').value = data.uyelikTarihi;
                 document.querySelector('input[name="TckimlikNo"]').value = data.tcKimlikNo;
                 document.querySelector('input[name="Ad"]').value = data.ad;
                 document.querySelector('input[name="Soyad"]').value = data.soyad;
                 document.querySelector('input[name="EvlilikSoyadi"]').value = data.evlilikSoyadi;
                 document.querySelector('input[name="DogumTarihi"]').value = data.dogumTarihi;
                 document.querySelector('input[name="DogumYeri"]').value = data.dogumYeri;
                 document.querySelector('input[name="Vefat"]').checked = data.vefat;
                 document.querySelector('input[name="Telefon"]').value = data.telefon;
                 document.querySelector('input[name="Email"]').value = data.email;
                 document.querySelector('input[name="Il"]').value = data.il;
                 document.querySelector('input[name="Ilce"]').value = data.ilce;
                 document.querySelector('textarea[name="Adres"]').value = data.adres;
                 document.querySelector('input[name="Universite"]').value = data.universite;
                 document.querySelector('input[name="Fakulte"]').value = data.fakulte;
                 document.querySelector('input[name="MezuniyetYili"]').value = data.mezuniyetYili;
                 document.querySelector('input[name="Meslek"]').value = data.meslek;
                 document.querySelector('select[name="KayitDurumu"]').value = data.kayitDurumu;

                 // --- AİDAT KISMI (ÖNEMLİ DEĞİŞİKLİK) ---

                 // 1. Geçmiş Aidatları Listele (Badge olarak)
                 var aidatDiv = document.getElementById("aidatListesiBadge");
                 aidatDiv.innerHTML = ""; // Önce temizle

                 if (data.gecmisAidatlar && data.gecmisAidatlar.length > 0) {
                     data.gecmisAidatlar.forEach(aidat => {
                         // Her aidat için bir etiket oluştur
                         var span = document.createElement("span");
                         span.className = "badge bg-secondary";
                         span.textContent = aidat.yil + ": " + aidat.tutar + " TL";
                         aidatDiv.appendChild(span);
                     });
                 } else {
                     aidatDiv.innerHTML = "<span class='text-muted small'>Geçmiş ödeme yok.</span>";
                 }

                 // 2. Yeni Giriş İçin Inputları Temizle ve AÇ (Disabled False)
                 var yilInput = document.querySelector('input[name="AidatYili"]');
                 var tutarInput = document.querySelector('input[name="AidatTutari"]');

                 yilInput.value = new Date().getFullYear(); // Mevcut yıl gelsin
                 tutarInput.value = ""; // Tutar boş gelsin ki kullanıcı yeni girsin

                 yilInput.disabled = false;
                 tutarInput.disabled = false;

                 var myModal = new bootstrap.Modal(document.getElementById('yeniUyeModal'));
                 myModal.show();
             })
             .catch(error => console.error('Hata:', error));
     }
</script>